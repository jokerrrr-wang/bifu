# äº¤æ˜“ç³»ç»Ÿæ¶æ„

> æ–‡æ¡£ç”Ÿæˆæ—¥æœŸï¼š2025å¹´12æœˆ3æ—¥  
> ç³»ç»Ÿç‰ˆæœ¬ï¼šåŸºäº Spring Boot 2.7.12 + gRPC 1.56.0 + JRaft 1.4.0

---

## ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#1-ç³»ç»Ÿæ¦‚è¿°)
2. [æ ¸å¿ƒæŠ€æœ¯æ ˆ](#2-æ ¸å¿ƒæŠ€æœ¯æ ˆ)
3. [æœåŠ¡æ¶æ„å…¨æ™¯](#3-æœåŠ¡æ¶æ„å…¨æ™¯)
4. [æ ¸å¿ƒæœåŠ¡è¯¦è§£](#4-æ ¸å¿ƒæœåŠ¡è¯¦è§£)
5. [é€šä¿¡æœºåˆ¶](#5-é€šä¿¡æœºåˆ¶)
6. [æ•°æ®æµè½¬](#6-æ•°æ®æµè½¬)
7. [é«˜å¯ç”¨è®¾è®¡](#7-é«˜å¯ç”¨è®¾è®¡)
8. [æ€§èƒ½ä¼˜åŒ–](#8-æ€§èƒ½ä¼˜åŒ–)

---

## 1. ç³»ç»Ÿæ¦‚è¿°

### 1.1 ä¸šåŠ¡èŒƒå›´

æœ¬ç³»ç»Ÿæ˜¯ä¸€ä¸ª**é«˜æ€§èƒ½åŠ å¯†è´§å¸äº¤æ˜“å¹³å°**ï¼Œæ”¯æŒï¼š

- **ç°è´§äº¤æ˜“**ï¼ˆSpot Tradingï¼‰ï¼šå…¨é¢ä¹°å–æ•°å­—èµ„äº§
- **åˆçº¦äº¤æ˜“**ï¼ˆContract/Margin Tradingï¼‰ï¼šç»Ÿä¸€ä¿è¯é‡‘æ æ†äº¤æ˜“
- **è¡ç”Ÿå“äº¤æ˜“**ï¼šæ°¸ç»­åˆçº¦ã€æœŸè´§åˆçº¦ç­‰

### 1.2 ç³»ç»Ÿç‰¹ç‚¹

#### é«˜æ€§èƒ½
- å•åˆ†ç‰‡æ”¯æŒ **5000+ TPS**ï¼ˆäº¤æ˜“æœåŠ¡ï¼‰
- å•åˆ†ç‰‡æ”¯æŒ **10000+ TPS**ï¼ˆæ’®åˆæœåŠ¡ï¼‰
- å…¨å†…å­˜å¤„ç†ï¼Œå¾®ç§’çº§å“åº”

#### é«˜å¯ç”¨
- åŸºäº JRaft å®ç°åˆ†å¸ƒå¼ä¸€è‡´æ€§
- æ¯ä¸ªåˆ†ç‰‡è‡³å°‘ 3 ä¸ªå®ä¾‹
- è‡ªåŠ¨æ•…éšœè½¬ç§»å’Œ Leader é€‰ä¸¾

#### å¯æ‰©å±•
- æŒ‰è´¦æˆ· ID åˆ†ç‰‡çš„æ°´å¹³æ‰©å±•
- æŒ‰äº¤æ˜“å¯¹åˆ†ç‰‡çš„æ’®åˆå¼•æ“
- æ— çŠ¶æ€ç½‘å…³å±‚æ”¯æŒå¼¹æ€§ä¼¸ç¼©

---

## 2. æ ¸å¿ƒæŠ€æœ¯æ ˆ

### 2.1 åŸºç¡€æ¡†æ¶

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Java | OpenJDK 17 | å¼€å‘è¯­è¨€ |
| Spring Boot | 2.7.12 | åº”ç”¨æ¡†æ¶ |
| gRPC | 1.56.0 | RPC é€šä¿¡ |
| Protocol Buffers | 3.22.3 | åºåˆ—åŒ–åè®® |

### 2.2 åˆ†å¸ƒå¼ç»„ä»¶

| ç»„ä»¶ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| SOFAJRaft | 1.4.0 | åˆ†å¸ƒå¼ä¸€è‡´æ€§ï¼ˆRaft åè®®ï¼‰ |
| RocketMQ | 5.x | æ¶ˆæ¯é˜Ÿåˆ— |
| Nacos | 2.1.0 | æœåŠ¡å‘ç° + é…ç½®ä¸­å¿ƒ |
| Redis | 7.x | ç¼“å­˜ + é™æµ |

### 2.3 å­˜å‚¨ä¸ç›‘æ§

| æŠ€æœ¯ | ç”¨é€” |
|------|------|
| MySQL 5.7 | å…³ç³»å‹æ•°æ®å­˜å‚¨ |
| ClickHouse | åˆ†æå‹æ•°æ®å­˜å‚¨ï¼ˆå¯é€‰ï¼‰ |
| Prometheus/VictoriaMetrics | æŒ‡æ ‡é‡‡é›† |
| Grafana | ç›‘æ§å¯è§†åŒ– |
| Loki | æ—¥å¿—èšåˆ |
| OpenTelemetry | é“¾è·¯è¿½è¸ª |

---

## 3. æœåŠ¡æ¶æ„å…¨æ™¯

### 3.1 æ•´ä½“æ¶æ„å›¾

```
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   ç”¨æˆ·è¯·æ±‚å±‚     â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                â”‚                â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
          â”‚ HTTP Gatewayâ”‚  â”‚ WebSocket â”‚  â”‚ GRPC Gatewayâ”‚
          â”‚  (Cobra)    â”‚  â”‚  (Lizard) â”‚  â”‚             â”‚
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                â”‚                â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   gRPC é€šä¿¡å±‚    â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                           â”‚                           â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Trade-Proxy â”‚          â”‚  History-Server   â”‚      â”‚  Quote-Server   â”‚
â”‚  (è·¯ç”±å±‚)   â”‚          â”‚   (å†å²æ•°æ®)       â”‚      â”‚   (è¡Œæƒ…æœåŠ¡)     â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ è·¯ç”±åˆ°åˆ†ç‰‡
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Trade-Server é›†ç¾¤               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Shard-A â”‚  â”‚ Shard-B â”‚  â”‚ Shard-C â”‚ â”‚
â”‚  â”‚ (JRaft) â”‚  â”‚ (JRaft) â”‚  â”‚ (JRaft) â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚           â”‚            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
              â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
              â”‚ RocketMQ  â”‚
              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                    â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚             â”‚             â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Match-Serverâ”‚ â”‚Funding â”‚ â”‚Liquidate      â”‚
â”‚  (æ’®åˆ)     â”‚ â”‚ Server â”‚ â”‚ Server        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æœåŠ¡æ¸…å•

#### æ ¸å¿ƒäº¤æ˜“æœåŠ¡
- **unimargin-trade-server**: ä¿è¯é‡‘è´¦æˆ·ç®¡ç†ï¼ˆæœ‰çŠ¶æ€ï¼ŒJRaftï¼‰
- **unimargin-trade-proxy**: äº¤æ˜“è·¯ç”±ä»£ç†ï¼ˆæ— çŠ¶æ€ï¼‰
- **spot-trade-server**: ç°è´§è´¦æˆ·ç®¡ç†ï¼ˆæœ‰çŠ¶æ€ï¼ŒJRaftï¼‰
- **spot-trade-proxy**: ç°è´§è·¯ç”±ä»£ç†ï¼ˆæ— çŠ¶æ€ï¼‰

#### ç½‘å…³æœåŠ¡
- **unimargin-http-gateway**: HTTP API ç½‘å…³
- **unimargin-websocket-gateway**: WebSocket æ¨é€ç½‘å…³
- **unimargin-grpc-gateway**: gRPC ç½‘å…³ï¼ˆå¯¹å¤–ï¼‰

#### æ•°æ®æœåŠ¡
- **unimargin-history-server**: å†å²æ•°æ®å­˜å‚¨ä¸æŸ¥è¯¢
- **unimargin-quote-server**: è¡Œæƒ…æ•°æ®ç”Ÿæˆä¸æ¨é€

#### æ’®åˆä¸è®¡ç®—
- **unimargin-match-server**: è®¢å•æ’®åˆå¼•æ“
- **unimargin-index-server**: æŒ‡æ•°ä»·æ ¼è®¡ç®—
- **unimargin-funding-server**: èµ„é‡‘è´¹ç‡è®¡ç®—

#### é£æ§æœåŠ¡
- **unimargin-liquidate-server**: å¼ºå¹³æ¸…ç®—æœåŠ¡

#### ç®¡ç†æœåŠ¡
- **decode-admin-server**: åå°ç®¡ç†æœåŠ¡
- **unimargin-activity-server**: æ´»åŠ¨ä¸æ¨èæœåŠ¡

#### é€šç”¨ç»„ä»¶
- **unimargin-common**: å…¬å…±ç»„ä»¶åº“
- **unimargin-protos**: gRPC Proto å®šä¹‰

---

## 4. æ ¸å¿ƒæœåŠ¡è¯¦è§£

### 4.1 Trade-Serverï¼ˆäº¤æ˜“æ ¸å¿ƒæœåŠ¡ï¼‰

#### 4.1.1 æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Trade-Server Architecture           â”‚
â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚       gRPC Service Layer             â”‚ â”‚
â”‚  â”‚  - AccountService                    â”‚ â”‚
â”‚  â”‚  - DepositService                    â”‚ â”‚
â”‚  â”‚  - WithdrawService                   â”‚ â”‚
â”‚  â”‚  - TransferService                   â”‚ â”‚
â”‚  â”‚  - OrderService                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚      ShardManager (åˆ†ç‰‡ç®¡ç†)          â”‚ â”‚
â”‚  â”‚  - æ£€æŸ¥ Leader çŠ¶æ€                   â”‚ â”‚
â”‚  â”‚  - é Leader è‡ªåŠ¨è½¬å‘                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚      JRaft State Machine             â”‚ â”‚
â”‚  â”‚  - Raft æ—¥å¿—å¤åˆ¶                      â”‚ â”‚
â”‚  â”‚  - çŠ¶æ€æœºå›æ”¾                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚     TradeStore (å†…å­˜å­˜å‚¨)             â”‚ â”‚
â”‚  â”‚  - AccountData: è´¦æˆ·æ•°æ®              â”‚ â”‚
â”‚  â”‚  - å……å€¼/æç°/è½¬è´¦å•æ®                  â”‚ â”‚
â”‚  â”‚  - å§”æ‰˜è®¢å•æ•°æ®                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                 â”‚                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    Event Producer (MQ)               â”‚ â”‚
â”‚  â”‚  - TradeEvent å‘é€åˆ° RocketMQ        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.1.2 æ ¸å¿ƒç‰¹æ€§

**1. åˆ†ç‰‡æœºåˆ¶**
```java
// ShardManager.java - åˆ†ç‰‡è·¯ç”±
public void checkManagedAccountId(long accountId) {
    int shardId = ShardIdUtil.toShardId(accountId);
    if (!managedShardIdSet.contains(shardId)) {
        throw ACCOUNT_SHARD_ID_CONFLICT;
    }
}
```

- æŒ‰ **è´¦æˆ· ID** è¿›è¡Œåˆ†ç‰‡ï¼ˆé€šå¸¸å–æ¨¡ï¼‰
- æ¯ä¸ªåˆ†ç‰‡ç®¡ç† 0-255 ä¸ª Shard ID
- é…ç½®ç¤ºä¾‹ï¼š`Shard-A: [0x00-0x7F]`, `Shard-B: [0x80-0xFF]`

**2. JRaft ä¸€è‡´æ€§**
```
Leader èŠ‚ç‚¹å¤„ç†æµç¨‹ï¼š
1. æ¥æ”¶ gRPC è¯·æ±‚
2. å°è£…ä¸º Raft Log
3. å¤åˆ¶åˆ° Follower èŠ‚ç‚¹ï¼ˆå¤šæ•°æ´¾ç¡®è®¤ï¼‰
4. Apply åˆ°çŠ¶æ€æœº
5. è¿”å›ç»“æœ

Follower èŠ‚ç‚¹ï¼š
- æ¥æ”¶åˆ°è¯·æ±‚è‡ªåŠ¨è½¬å‘åˆ° Leader
- é€šè¿‡ gRPC Channel è½¬å‘
```

**3. å…¨å†…å­˜è®¾è®¡**
- æ‰€æœ‰è´¦æˆ·æ•°æ®å­˜å‚¨åœ¨å†…å­˜ `AccountData` å¯¹è±¡
- å®šæœŸç”Ÿæˆå¿«ç…§æŒä¹…åŒ–
- é€šè¿‡ RocketMQ å‘é€äº‹ä»¶åˆ°æŒä¹…åŒ–å±‚

**4. äº‹ä»¶é©±åŠ¨**
```protobuf
// TradeEvent ç»“æ„
message TradeInternalEvent {
  int64 account_id = 1;
  int64 version = 2;
  EventType event_type = 3;
  Account account = 4;           // è´¦æˆ·å¿«ç…§
  repeated BalanceFlow flows = 5; // èµ„äº§æµæ°´
}
```

#### 4.1.3 æ€§èƒ½æŒ‡æ ‡
- **ååé‡**: 5000+ TPS/åˆ†ç‰‡
- **å»¶è¿Ÿ**: P99 < 10ms
- **å¹¶å‘**: å•åˆ†ç‰‡æ”¯æŒ 10ä¸‡+ è´¦æˆ·

---

### 4.2 Trade-Proxyï¼ˆäº¤æ˜“è·¯ç”±ä»£ç†ï¼‰

#### 4.2.1 æ¶æ„èŒè´£

```
Client Request
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Trade-Proxy             â”‚
â”‚                            â”‚
â”‚  1. gRPC Service æš´éœ²      â”‚
â”‚  2. è§£æ account_id        â”‚
â”‚  3. è®¡ç®— shard_id          â”‚
â”‚  4. è·¯ç”±åˆ°åç«¯ Trade-Serverâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ShardManager              â”‚
â”‚  - serverIdToShardIdMap    â”‚
â”‚  - ç»´æŠ¤ gRPC Channel æ±     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“
Trade-Server-Shard-A/B/C
```

#### 4.2.2 å…³é”®ä»£ç 
```java
// ShardManager.java - Trade-Proxy
public AccountServiceGrpc.AccountServiceFutureStub 
    getAccountServiceFutureStubByShardId(int shardId) {
    String serverId = shardIdToServerIdMap.get(shardId);
    return serverIdToChannelAndStubMap
        .computeIfAbsent(serverId, this::createChannel)
        .accountServiceFutureStub;
}
```

#### 4.2.3 é…ç½®ç¤ºä¾‹
```yaml
# Trade-Proxy åˆ†ç‰‡é…ç½®
shard-mapping:
  unimargin-trade-server-a: [0x00-0x7F]
  unimargin-trade-server-b: [0x80-0xFF]
```

---

### 4.3 HTTP Gatewayï¼ˆHTTP ç½‘å…³ï¼‰

#### 4.3.1 æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      HTTP Request (RESTful)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Filter Chain                   â”‚
â”‚  1. AuthenticationFilter (JWT)      â”‚
â”‚  2. RateLimitFilter (Sentinel)      â”‚
â”‚  3. SignatureValidationFilter       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Controller Layer               â”‚
â”‚  - /api/v1/private/contract/*       â”‚
â”‚  - /api/v1/private/spot/*           â”‚
â”‚  - /api/v1/public/*                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      gRPC Client Stub               â”‚
â”‚  - Trade-Proxy                      â”‚
â”‚  - History-Server                   â”‚
â”‚  - Quote-Server                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.3.2 æ ¸å¿ƒåŠŸèƒ½

**1. é‰´æƒæœºåˆ¶**
```java
// AuthInterceptor.java
@Component
public class AuthInterceptor implements HandlerInterceptor {
    public boolean preHandle(HttpServletRequest request, ...) {
        String token = request.getHeader("Authorization");
        // JWT Token éªŒè¯
        // æå– user_id å¹¶è®¾ç½®åˆ° Context
    }
}
```

**2. é™æµç­–ç•¥**
```java
// ä½¿ç”¨ Sentinel è¿›è¡Œé™æµ
@SentinelResource(value = "createOrder", 
                  blockHandler = "handleRateLimit")
public Response createOrder(OrderRequest request) {
    // ä¸šåŠ¡é€»è¾‘
}
```

**3. API ç«¯ç‚¹ç¤ºä¾‹**
```
POST /api/v1/private/contract/order/create
POST /api/v1/private/contract/account/transfer
GET  /api/v1/private/contract/account/info
GET  /api/v1/public/quote/ticker
```

---

### 4.4 History-Serverï¼ˆå†å²æ•°æ®æœåŠ¡ï¼‰

#### 4.4.1 æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      RocketMQ Consumer              â”‚
â”‚  - TradeEvent                       â”‚
â”‚  - MatchEvent                       â”‚
â”‚  - FundingEvent                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Event Handler                  â”‚
â”‚  - è§£æäº‹ä»¶                          â”‚
â”‚  - æ•°æ®è½¬æ¢                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Database Layer                 â”‚
â”‚  - MySQL: ç»“æ„åŒ–æ•°æ®                 â”‚
â”‚  - ClickHouse: åˆ†ææ•°æ®ï¼ˆå¯é€‰ï¼‰      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      gRPC Query Service             â”‚
â”‚  - HistoryAccountService            â”‚
â”‚  - HistoryOrderService              â”‚
â”‚  - HistoryDepositService            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.4.2 æ•°æ®å­˜å‚¨

**æ•°æ®åº“è¡¨è®¾è®¡**ï¼ˆç¤ºä¾‹ï¼‰
```sql
-- è´¦æˆ·å¿«ç…§è¡¨
CREATE TABLE account_snapshot (
    account_id BIGINT PRIMARY KEY,
    version BIGINT,
    balance_json JSON,
    updated_at TIMESTAMP
);

-- è®¢å•å†å²è¡¨
CREATE TABLE order_history (
    order_id BIGINT PRIMARY KEY,
    account_id BIGINT,
    instrument_id VARCHAR(32),
    side ENUM('BUY', 'SELL'),
    status ENUM('PENDING', 'FILLED', 'CANCELLED'),
    created_at TIMESTAMP,
    INDEX idx_account (account_id, created_at)
);

-- èµ„äº§æµæ°´è¡¨
CREATE TABLE balance_flow (
    flow_id BIGINT PRIMARY KEY,
    account_id BIGINT,
    asset_id VARCHAR(32),
    change_amount DECIMAL(38, 18),
    reason VARCHAR(64),
    created_at TIMESTAMP
);
```

#### 4.4.3 æŸ¥è¯¢ä¼˜åŒ–
- æŒ‰ account_id åˆ†åŒº
- å†·çƒ­æ•°æ®åˆ†ç¦»ï¼ˆå½’æ¡£æ—§æ•°æ®ï¼‰
- è¯»å†™åˆ†ç¦»ï¼ˆä¸»ä»å¤åˆ¶ï¼‰
- Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®

---

### 4.5 Match-Serverï¼ˆæ’®åˆå¼•æ“ï¼‰

#### 4.5.1 æ’®åˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      RocketMQ Consumer              â”‚
â”‚  - OrderCreateEvent                 â”‚
â”‚  - OrderCancelEvent                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      KernelProcessor                â”‚
â”‚  - äº‹ä»¶è§£æ                          â”‚
â”‚  - é¡ºåºå¤„ç†                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Order Book (å†…å­˜)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  BUY  â”‚  SELL               â”‚    â”‚
â”‚  â”‚ Price â”‚ Price               â”‚    â”‚
â”‚  â”‚ 50000 â”‚ 50001               â”‚    â”‚
â”‚  â”‚ 49999 â”‚ 50002               â”‚    â”‚
â”‚  â”‚ 49998 â”‚ 50003               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Matcher (æ’®åˆç®—æ³•)             â”‚
â”‚  - ä»·æ ¼ä¼˜å…ˆ                          â”‚
â”‚  - æ—¶é—´ä¼˜å…ˆ                          â”‚
â”‚  - éƒ¨åˆ†æˆäº¤                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      RocketMQ Producer              â”‚
â”‚  - MatchEvent (æˆäº¤äº‹ä»¶)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.5.2 æ’®åˆç®—æ³•

```java
// Matcher.java - æ ¸å¿ƒæ’®åˆé€»è¾‘
public MatchResult match(OrderNode takerOrder, OrderBook orderBook) {
    PriceNodeList makerSide = (takerOrder.isBuy()) 
        ? orderBook.getSellSide() 
        : orderBook.getBuySide();
    
    while (takerOrder.hasRemaining() && makerSide.hasOrders()) {
        OrderNode makerOrder = makerSide.getBestOrder();
        
        // ä»·æ ¼æ£€æŸ¥
        if (!priceMatch(takerOrder, makerOrder)) {
            break;
        }
        
        // æˆäº¤
        long matchQty = Math.min(
            takerOrder.getRemainingQty(), 
            makerOrder.getRemainingQty()
        );
        
        executeTrade(takerOrder, makerOrder, matchQty);
    }
    
    return buildMatchResult();
}
```

#### 4.5.3 æ€§èƒ½ä¼˜åŒ–
- **æ•°æ®ç»“æ„**: çº¢é»‘æ ‘å­˜å‚¨ä»·æ ¼æ¡£ä½
- **å†…å­˜æ± **: é¢„åˆ†é… OrderNode å¯¹è±¡
- **é›¶æ‹·è´**: ç›´æ¥æ“ä½œ Protobuf å¯¹è±¡
- **å•çº¿ç¨‹**: é¿å…é”ç«äº‰

---

### 4.6 Quote-Serverï¼ˆè¡Œæƒ…æœåŠ¡ï¼‰

#### 4.6.1 è¡Œæƒ…ç”Ÿæˆ

```
Match Result (MQ)
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Quote Processor       â”‚
â”‚  - è§£ææˆäº¤æ•°æ®          â”‚
â”‚  - æ›´æ–° Ticker           â”‚
â”‚  - ç”Ÿæˆ Kçº¿              â”‚
â”‚  - æ›´æ–°æ·±åº¦              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â†’ Ticker (æœ€æ–°ä»·æ ¼)
           â”œâ”€â”€â†’ Kline (1m, 5m, 1h, 1d)
           â”œâ”€â”€â†’ Depth (ä¹°å–ç›˜å£)
           â””â”€â”€â†’ 24h Stats
```

#### 4.6.2 Kçº¿è®¡ç®—
```java
// KlineData.java
@Builder
public class KlineData {
    long openTime;
    BigDecimal open;
    BigDecimal high;
    BigDecimal low;
    BigDecimal close;
    BigDecimal volume;
    
    public void update(MatchResult match) {
        this.high = max(this.high, match.getPrice());
        this.low = min(this.low, match.getPrice());
        this.close = match.getPrice();
        this.volume = this.volume.add(match.getQty());
    }
}
```

#### 4.6.3 æ¨é€æœºåˆ¶
- é€šè¿‡ gRPC æ¨é€åˆ° WebSocket Gateway
- å¢é‡æ¨é€ï¼ˆä»…æ¨é€å˜åŒ–æ•°æ®ï¼‰
- é¢‘ç‡æ§åˆ¶ï¼ˆæœ€å¿« 100ms/æ¬¡ï¼‰

---

### 4.7 æ”¯æ’‘æœåŠ¡

#### 4.7.1 Index-Serverï¼ˆæŒ‡æ•°ä»·æ ¼ï¼‰

**åŠŸèƒ½**ï¼š
- è®¢é˜…å¤šä¸ªäº¤æ˜“æ‰€çš„ä»·æ ¼æ•°æ®
- è®¡ç®—åŠ æƒå¹³å‡æŒ‡æ•°ä»·æ ¼
- æ¨é€ç»™ Trade-Server å’Œ Quote-Server

**ä»·æ ¼æº**ï¼š
```yaml
price-sources:
  - exchange: binance
    weight: 0.4
  - exchange: okx
    weight: 0.3
  - exchange: bybit
    weight: 0.3
```

**è®¡ç®—å…¬å¼**ï¼š
```
Index Price = Î£(Price_i Ã— Weight_i)
```

#### 4.7.2 Funding-Serverï¼ˆèµ„é‡‘è´¹ç‡ï¼‰

**åŠŸèƒ½**ï¼š
- æ¯ 8 å°æ—¶è®¡ç®—ä¸€æ¬¡èµ„é‡‘è´¹ç‡
- åŸºäºç°è´§ä»·æ ¼ä¸åˆçº¦ä»·æ ¼å·®å¼‚
- é€šçŸ¥ Trade-Server è¿›è¡Œè´¹ç‡ç»“ç®—

**è´¹ç‡å…¬å¼**ï¼š
```
Funding Rate = (Mark Price - Index Price) / Index Price Ã— Factor
```

#### 4.7.3 Liquidate-Serverï¼ˆå¼ºå¹³æœåŠ¡ï¼‰

**åŠŸèƒ½**ï¼š
- ç›‘å¬è´¦æˆ·çŠ¶æ€å˜æ›´äº‹ä»¶
- è®¡ç®—ä¿è¯é‡‘ç‡
- è§¦å‘å¼ºåˆ¶å¹³ä»“

**å¼ºå¹³åˆ¤æ–­**ï¼š
```java
// ä¿è¯é‡‘ç‡è®¡ç®—
marginRatio = (accountEquity - positionValue Ã— maintenanceMargin) 
              / positionValue

if (marginRatio < liquidationThreshold) {
    triggerLiquidation(accountId);
}
```

---

## 5. é€šä¿¡æœºåˆ¶

### 5.1 gRPC é€šä¿¡

#### 5.1.1 æœåŠ¡å‘ç°
```yaml
# åŸºäº Nacos çš„æœåŠ¡å‘ç°
grpc:
  client:
    unimargin-trade-proxy:
      address: nacos://unimargin-trade-proxy
      negotiation-type: PLAINTEXT
      default-load-balancing-policy: round_robin
```

#### 5.1.2 è´Ÿè½½å‡è¡¡
- **Round Robin**: è½®è¯¢ï¼ˆé»˜è®¤ï¼‰
- **JRaft è‡ªå®šä¹‰**: åªè·¯ç”±åˆ° Leader èŠ‚ç‚¹

#### 5.1.3 è¶…æ—¶ä¸é‡è¯•
```yaml
grpc:
  client:
    GLOBAL:
      keep-alive-time: 30s
      keep-alive-timeout: 5s
      deadline: 5s  # è¯·æ±‚è¶…æ—¶
```

### 5.2 æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRocketMQï¼‰

#### 5.2.1 Topic è®¾è®¡
```
trade-event-topic              # äº¤æ˜“äº‹ä»¶
â”œâ”€ Tag: ACCOUNT_UPDATED        # è´¦æˆ·æ›´æ–°
â”œâ”€ Tag: ORDER_FILLED           # è®¢å•æˆäº¤
â””â”€ Tag: BALANCE_CHANGED        # ä½™é¢å˜æ›´

match-event-topic              # æ’®åˆäº‹ä»¶
â”œâ”€ Tag: ORDER_MATCHED          # è®¢å•åŒ¹é…
â””â”€ Tag: TRADE_EXECUTED         # äº¤æ˜“æ‰§è¡Œ

index-price-topic              # æŒ‡æ•°ä»·æ ¼
funding-rate-topic             # èµ„é‡‘è´¹ç‡
```

#### 5.2.2 é¡ºåºä¿è¯
```java
// æŒ‰ account_id ä¿è¯é¡ºåº
producer.send(message, new MessageQueueSelector() {
    public MessageQueue select(List<MessageQueue> mqs, 
                               Message msg, Object arg) {
        long accountId = (Long) arg;
        int index = (int) (accountId % mqs.size());
        return mqs.get(index);
    }
}, accountId);
```

#### 5.2.3 æ¶ˆè´¹æ¨¡å¼
- **é›†ç¾¤æ¶ˆè´¹**: History-Serverï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
- **å¹¿æ’­æ¶ˆè´¹**: Liquidate-Serverï¼ˆæ‰€æœ‰å®ä¾‹ï¼‰

---

## 6. æ•°æ®æµè½¬

### 6.1 ä¸‹å•æµç¨‹

```
User
  â†“ (1) POST /api/v1/private/contract/order/create
HTTP Gateway
  â†“ (2) gRPC CreateOrder(account_id, instrument_id, ...)
Trade-Proxy
  â†“ (3) è®¡ç®— shard_id, è·¯ç”±åˆ° Trade-Server-Shard-A
Trade-Server (Leader)
  â†“ (4) JRaft æ—¥å¿—å¤åˆ¶
  â†“ (5) Apply: æ‰£å‡ä¿è¯é‡‘, åˆ›å»ºè®¢å•
  â†“ (6) å‘é€ OrderCreateEvent â†’ RocketMQ
Match-Server
  â†“ (7) æ¶ˆè´¹äº‹ä»¶, åŠ å…¥ Order Book
  â†“ (8) æ’®åˆæˆäº¤
  â†“ (9) å‘é€ MatchEvent â†’ RocketMQ
Trade-Server
  â†“ (10) æ¶ˆè´¹ MatchEvent, æ›´æ–°è®¢å•çŠ¶æ€
  â†“ (11) å‘é€ TradeEvent â†’ RocketMQ
History-Server
  â†“ (12) æŒä¹…åŒ–è®¢å•å†å²
Quote-Server
  â†“ (13) æ›´æ–°è¡Œæƒ…æ•°æ®
WebSocket Gateway
  â†“ (14) æ¨é€æˆäº¤é€šçŸ¥ç»™ User
```

### 6.2 å……å€¼æµç¨‹

```
åŒºå—é“¾ Transfer ç¡®è®¤
  â†“
Wallet Service (å¤–éƒ¨)
  â†“ gRPC ConfirmDeposit(account_id, asset_id, amount)
Trade-Server
  â†“ JRaft æ—¥å¿—å¤åˆ¶
  â†“ Apply: å¢åŠ ä½™é¢
  â†“ å‘é€ DepositEvent â†’ RocketMQ
History-Server
  â†“ æŒä¹…åŒ–å……å€¼è®°å½•
WebSocket Gateway
  â†“ æ¨é€å……å€¼åˆ°è´¦é€šçŸ¥
```

### 6.3 èµ„é‡‘è´¹ç‡ç»“ç®—

```
å®šæ—¶ä»»åŠ¡ (æ¯ 8 å°æ—¶)
  â†“
Funding-Server
  â†“ è®¡ç®—èµ„é‡‘è´¹ç‡
  â†“ å‘é€ FundingRateEvent â†’ RocketMQ
Trade-Server (æ‰€æœ‰åˆ†ç‰‡)
  â†“ æ¶ˆè´¹äº‹ä»¶
  â†“ éå†æŒä»“è´¦æˆ·
  â†“ è®¡ç®—å¹¶æ‰£é™¤èµ„é‡‘è´¹ç”¨
  â†“ å‘é€ FundingEvent â†’ RocketMQ
History-Server
  â†“ è®°å½•èµ„é‡‘è´¹ç”¨å†å²
```

---

## 7. é«˜å¯ç”¨è®¾è®¡

### 7.1 JRaft ä¸€è‡´æ€§ä¿è¯

#### 7.1.1 é›†ç¾¤é…ç½®
```properties
# Trade-Server-Shard-A
jraft.group-id = trade-shard-a
jraft.initial-conf = 
    node1:192.168.1.101:9002,
    node2:192.168.1.102:9002,
    node3:192.168.1.103:9002
```

#### 7.1.2 Leader é€‰ä¸¾
- ä½¿ç”¨ Raft åè®®è‡ªåŠ¨é€‰ä¸¾
- å¤šæ•°æ´¾å­˜æ´»å³å¯é€‰å‡º Leader
- é€‰ä¸¾è¶…æ—¶ï¼š150-300ms

#### 7.1.3 æ—¥å¿—å¤åˆ¶
```
Client â†’ Leader â†’ (Append Log Entry)
                  â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼        â–¼        â–¼
    Follower  Follower  Follower
         â”‚        â”‚        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
         Majority Committed
                  â†“
         Apply to State Machine
```

### 7.2 æ•…éšœæ¢å¤

#### åœºæ™¯ 1: Leader å®•æœº
```
1. Follower æ£€æµ‹å¿ƒè·³è¶…æ—¶
2. å‘èµ·æ–°ä¸€è½®é€‰ä¸¾
3. é€‰å‡ºæ–° Leader
4. å®¢æˆ·ç«¯è¯·æ±‚è‡ªåŠ¨è½¬å‘åˆ°æ–° Leader
æ€»è€—æ—¶: < 1 ç§’
```

#### åœºæ™¯ 2: å•ä¸ª Follower å®•æœº
```
- Leader ç»§ç»­æœåŠ¡
- å…¶ä»– Follower æ­£å¸¸å¤åˆ¶
- å®•æœºèŠ‚ç‚¹æ¢å¤åè‡ªåŠ¨è¿½èµ¶æ—¥å¿—
å½±å“: æ— æœåŠ¡ä¸­æ–­
```

#### åœºæ™¯ 3: ç½‘ç»œåˆ†åŒº
```
- å¤šæ•°æ´¾åˆ†åŒºç»§ç»­æœåŠ¡
- å°‘æ•°æ´¾åˆ†åŒºæ— æ³•å†™å…¥ï¼ˆè‡ªåŠ¨é™çº§ä¸ºåªè¯»ï¼‰
- åˆ†åŒºæ¢å¤åè‡ªåŠ¨åˆå¹¶æ—¥å¿—
```

### 7.3 æ•°æ®å¤‡ä»½

#### 7.3.1 å¿«ç…§æœºåˆ¶
```java
// æ¯ 1000 æ¡æ—¥å¿—ç”Ÿæˆä¸€æ¬¡å¿«ç…§
@Value("${jraft.snapshot.interval-logs}")
private int snapshotIntervalLogs = 1000;

// å¿«ç…§å†…å®¹
- account_data.snapshot       # æ‰€æœ‰è´¦æˆ·æ•°æ®
- metadata.json               # å…ƒæ•°æ®ï¼ˆç‰ˆæœ¬å·ç­‰ï¼‰
```

#### 7.3.2 ç¾éš¾æ¢å¤
```
1. ä»æœ€æ–°å¿«ç…§æ¢å¤
2. å›æ”¾å¿«ç…§åçš„ Raft Log
3. é‡æ–°åŠ å…¥é›†ç¾¤
æ¢å¤æ—¶é—´: å–å†³äºæ•°æ®é‡ï¼ˆé€šå¸¸ < 1 åˆ†é’Ÿï¼‰
```

---

## 8. æ€§èƒ½ä¼˜åŒ–

### 8.1 Trade-Server ä¼˜åŒ–

#### 8.1.1 å†…å­˜å¸ƒå±€
```java
// è´¦æˆ·æ•°æ®ç»“æ„ä¼˜åŒ–
class AccountData {
    // ä½¿ç”¨åŸå§‹ç±»å‹å‡å°‘è£…ç®±
    long accountId;
    long version;
    
    // ä½¿ç”¨æ•°ç»„ä»£æ›¿ Mapï¼ˆçƒ­ç‚¹èµ„äº§å›ºå®šä½ç½®ï¼‰
    BigDecimal[] balances;  // [BTC, ETH, USDT, ...]
    
    // å¯¹è±¡æ± å¤ç”¨
    ObjectPool<Order> orderPool;
}
```

#### 8.1.2 æ‰¹é‡å¤„ç†
```java
// æ‰¹é‡æäº¤åˆ° JRaft
List<Command> batch = new ArrayList<>();
for (int i = 0; i < 100; i++) {
    batch.add(commands.poll());
}
jraftNode.applyBatch(batch);
```

### 8.2 Match-Server ä¼˜åŒ–

#### 8.2.1 æ•°æ®ç»“æ„
```java
// Order Book ä½¿ç”¨çº¢é»‘æ ‘
TreeMap<BigDecimal, PriceNode> buyOrders;  // é™åº
TreeMap<BigDecimal, PriceNode> sellOrders; // å‡åº

// PriceNode ä½¿ç”¨é“¾è¡¨å­˜å‚¨åŒä»·è®¢å•
class PriceNode {
    BigDecimal price;
    LinkedList<OrderNode> orders;  // FIFO
    long totalQty;
}
```

#### 8.2.2 é›¶æ‹·è´
```java
// ç›´æ¥æ“ä½œ Protobuf ByteString
ByteString orderBytes = message.getBody();
Order.Builder builder = Order.newBuilder()
    .mergeFrom(orderBytes);
```

### 8.3 ç½‘å…³å±‚ä¼˜åŒ–

#### 8.3.1 è¿æ¥æ± 
```yaml
grpc:
  client:
    pool:
      max-size: 100
      min-idle: 10
```

#### 8.3.2 é™æµé…ç½®
```java
// Sentinel é™æµè§„åˆ™
FlowRule rule = new FlowRule()
    .setResource("createOrder")
    .setGrade(RuleConstant.FLOW_GRADE_QPS)
    .setCount(1000);  // 1000 QPS/å®ä¾‹
```

### 8.4 ç›‘æ§æŒ‡æ ‡

#### æ ¸å¿ƒæŒ‡æ ‡
```
# ä¸šåŠ¡æŒ‡æ ‡
order_create_total          # åˆ›å»ºè®¢å•æ€»æ•°
order_filled_total          # æˆäº¤è®¢å•æ€»æ•°
trade_latency_seconds       # äº¤æ˜“å»¶è¿Ÿ

# ç³»ç»ŸæŒ‡æ ‡
jraft_leader_term           # Leader ä»»æœŸ
jraft_log_index             # æ—¥å¿—ç´¢å¼•
jraft_commit_latency        # æäº¤å»¶è¿Ÿ

# JVM æŒ‡æ ‡
jvm_heap_used_bytes         # å †å†…å­˜ä½¿ç”¨
jvm_gc_pause_seconds        # GC æš‚åœæ—¶é—´
```

---

## 9. éƒ¨ç½²æ¶æ„

### 9.1 Kubernetes éƒ¨ç½²

```yaml
# trade-server-shard-a.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: trade-server-shard-a
spec:
  serviceName: trade-server-shard-a
  replicas: 3
  template:
    spec:
      containers:
      - name: trade-server
        image: trade-server:v1.0.0
        env:
        - name: JRAFT_SERVER_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: JRAFT_INITIAL_CONF
          value: "trade-server-shard-a-0:9002,trade-server-shard-a-1:9002,trade-server-shard-a-2:9002"
        ports:
        - containerPort: 8080  # HTTP
        - containerPort: 9001  # gRPC
        - containerPort: 9002  # JRaft
        volumeMounts:
        - name: data
          mountPath: /data/jraft
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 100Gi
```

### 9.2 èµ„æºé…ç½®å»ºè®®

| æœåŠ¡ | CPU | å†…å­˜ | ç£ç›˜ | å®ä¾‹æ•° |
|------|-----|------|------|--------|
| Trade-Server | 4æ ¸ | 16GB | 100GB SSD | 3/åˆ†ç‰‡ |
| Trade-Proxy | 2æ ¸ | 4GB | 20GB | 2+ |
| Match-Server | 8æ ¸ | 32GB | 100GB SSD | 3/äº¤æ˜“å¯¹ |
| HTTP Gateway | 2æ ¸ | 4GB | 20GB | 3+ |
| History-Server | 4æ ¸ | 8GB | 500GB | 2+ |

---

## 10. æ€»ç»“

### 10.1 ç³»ç»Ÿäº®ç‚¹

âœ… **æè‡´æ€§èƒ½**
- å…¨å†…å­˜å¤„ç†
- å•åˆ†ç‰‡ 5000+ TPS
- P99 å»¶è¿Ÿ < 10ms

âœ… **é«˜å¯ç”¨æ€§**
- JRaft åˆ†å¸ƒå¼ä¸€è‡´æ€§
- è‡ªåŠ¨æ•…éšœè½¬ç§»
- æ— å•ç‚¹æ•…éšœ

âœ… **æ¨ªå‘æ‰©å±•**
- æŒ‰è´¦æˆ· ID åˆ†ç‰‡
- æŒ‰äº¤æ˜“å¯¹åˆ†ç‰‡æ’®åˆ
- æ— çŠ¶æ€ç½‘å…³å¼¹æ€§ä¼¸ç¼©

âœ… **äº‹ä»¶é©±åŠ¨**
- å¼‚æ­¥è§£è€¦
- æœ€ç»ˆä¸€è‡´æ€§
- æ˜“äºæ‰©å±•æ–°åŠŸèƒ½

### 10.2 æŠ€æœ¯é€‰å‹ç†ç”±

| æŠ€æœ¯ | é€‰å‹ç†ç”± |
|------|----------|
| gRPC | é«˜æ€§èƒ½ RPCï¼Œå¼ºç±»å‹ï¼Œè·¨è¯­è¨€ |
| JRaft | æˆç†Ÿçš„ Raft å®ç°ï¼Œé‡‘èçº§å¯é æ€§ |
| RocketMQ | é¡ºåºæ¶ˆæ¯ï¼Œäº‹åŠ¡æ¶ˆæ¯ï¼Œé«˜åå |
| Nacos | æœåŠ¡å‘ç° + é…ç½®ä¸­å¿ƒï¼Œæ˜“è¿ç»´ |
| Spring Boot | ç”Ÿæ€å®Œå–„ï¼Œå¼€å‘æ•ˆç‡é«˜ |

### 10.3 æœªæ¥ä¼˜åŒ–æ–¹å‘

ğŸ”„ **æ€§èƒ½æå‡**
- å¼•å…¥ AOF æ—¥å¿—æ›¿ä»£ JRaftï¼ˆæ›´é«˜ååï¼‰
- ä½¿ç”¨ Disruptor æ›¿ä»£ MQ å†…éƒ¨é˜Ÿåˆ—
- RDMA ç½‘ç»œåŠ é€Ÿ

ğŸ“Š **åŠŸèƒ½å¢å¼º**
- æ”¯æŒæ›´å¤šè®¢å•ç±»å‹ï¼ˆå†°å±±å•ã€TWAPï¼‰
- è·¨å¸ç§ä¿è¯é‡‘
- æ™ºèƒ½è·¯ç”±ï¼ˆæœ€ä¼˜ä»·æ ¼æ‰§è¡Œï¼‰

ğŸ›¡ï¸ **å®‰å…¨åŠ å›º**
- å¤šé‡ç­¾å
- å†·çƒ­é’±åŒ…åˆ†ç¦»
- å®æ—¶é£æ§å¼•æ“

---

## é™„å½•

### A. Proto æ–‡ä»¶ç¤ºä¾‹

```protobuf
// account_rpc.proto
syntax = "proto3";

package decode.exchange.contract.trade.rpc;

service AccountService {
  rpc GetAccountInfo(GetAccountInfoRequest) 
      returns (GetAccountInfoResponse);
  
  rpc RegisterAccount(RegisterAccountRequest) 
      returns (RegisterAccountResponse);
}

message GetAccountInfoRequest {
  int64 account_id = 1;
}

message GetAccountInfoResponse {
  Account account = 1;
  repeated Balance balance = 2;
  int64 version = 3;
}
```

### B. é…ç½®æ–‡ä»¶ç¤ºä¾‹

```yaml
# application.yml (Trade-Server)
spring:
  application:
    name: unimargin-trade-server

grpc:
  server:
    port: 9001
  client:
    GLOBAL:
      negotiation-type: PLAINTEXT

jraft:
  group-id: trade-shard-a
  server-id: ${POD_NAME}:9002
  data-path: /data/jraft/

rocketmq:
  name-server: rocketmq:9876
  producer:
    group: trade-event-producer

nacos:
  discovery:
    server-addr: nacos:8848
```

### C. ç›‘æ§å‘Šè­¦è§„åˆ™

```yaml
# Prometheus Alert Rules
groups:
- name: trade-server
  rules:
  - alert: JRaftNoLeader
    expr: jraft_leader_term == 0
    for: 30s
    annotations:
      summary: "JRaft åˆ†ç‰‡æ—  Leader"
      
  - alert: HighTradeLatency
    expr: histogram_quantile(0.99, trade_latency_seconds) > 0.1
    for: 5m
    annotations:
      summary: "äº¤æ˜“å»¶è¿Ÿè¿‡é«˜ P99 > 100ms"
      
  - alert: OrderCreateFailed
    expr: rate(order_create_failed_total[5m]) > 10
    annotations:
      summary: "è®¢å•åˆ›å»ºå¤±è´¥ç‡è¿‡é«˜"
```

---

**æ–‡æ¡£ç»´æŠ¤**: è¯·éšç€ç³»ç»Ÿæ¼”è¿›åŠæ—¶æ›´æ–°æœ¬æ–‡æ¡£  
**è”ç³»æ–¹å¼**: æŠ€æœ¯å›¢é˜Ÿ tech@example.com  
**ç‰ˆæœ¬å†å²**: 
- v1.0 (2025-12-03): åˆå§‹ç‰ˆæœ¬
